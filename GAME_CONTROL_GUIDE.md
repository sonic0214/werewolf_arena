# 游戏终止和重启功能使用指南

## 概述

本指南介绍如何使用狼人杀AI对战平台新增的游戏终止和重启功能。

## 功能特点

- ✅ **优雅终止**: 游戏在完成当前轮次后安全停止
- ✅ **实时状态**: 实时显示游戏运行状态
- ✅ **便捷管理**: 在直播页面和主页都能控制游戏
- ✅ **状态持久化**: 游戏状态和日志得到完整保存

## 启动服务器

```bash
python3 web_server.py
```

服务器启动后访问: http://localhost:8081/

## 使用方法

### 1. 在直播页面控制游戏

当你在观看游戏直播时 (`/index_live.html?session_id=xxx`)，页面右上角会有游戏控制按钮：

```
[⏹️ 停止] [🔄 重启] ● 运行中
```

- **停止按钮** (⏹️): 优雅终止当前游戏
- **重启按钮** (🔄): 跳转回主页创建新游戏
- **状态指示器**: 显示游戏当前状态

### 2. 在主页管理游戏

主页底部有游戏管理面板：

```
🎮 游戏管理
[🔄 刷新列表]

游戏 abc123              [运行中]  [👁️ 观看] [⏹️ 停止]
村民: glmz1-flash | 狼人: glmz1-flash
开始时间: 2025-10-30 18:50:00
```

- **刷新列表**: 更新游戏状态
- **观看按钮**: 在新标签页打开游戏直播
- **停止按钮**: 停止正在运行的游戏

## 游戏状态说明

| 状态 | 说明 | 可执行操作 |
|------|------|------------|
| 初始化中 | 游戏正在启动 | 停止 |
| 运行中 | 游戏正在进行 | 停止、观看 |
| 停止中 | 正在优雅停止 | 无 |
| 已停止 | 游戏已被停止 | 观看 |
| 已完成 | 游戏自然结束 | 观看 |
| 错误 | 游戏运行出错 | 观看 |

## API 端点

以下是新增的API端点：

### 终止游戏
```http
POST /stop-game/{session_id}
```

**响应:**
```json
{
  "success": true,
  "message": "Game stop request sent. The game will finish the current round and stop gracefully.",
  "session_id": "session_20251030_025305",
  "final_status": "stopped"
}
```

### 查询游戏状态
```http
GET /game-status/{session_id}
```

**响应:**
```json
{
  "success": true,
  "session_id": "session_20251030_025305",
  "status": "running",
  "v_model": "glmz1-flash",
  "w_model": "glmz1-flash",
  "start_time": 1698671400,
  "error": null
}
```

### 获取游戏列表
```http
GET /list-games
```

**响应:**
```json
{
  "success": true,
  "games": [
    {
      "session_id": "session_20251030_025305",
      "status": "running",
      "v_model": "glmz1-flash",
      "w_model": "glmz1-flash",
      "start_time": 1698671400,
      "log_directory": "logs/session_20251030_025305",
      "winner": null
    }
  ]
}
```

## 注意事项

1. **优雅停止**: 游戏会在完成当前轮次后停止，不会立即中断
2. **数据保存**: 停止游戏时会保存当前的游戏状态和日志
3. **状态轮询**: 前端每5秒自动更新游戏状态
4. **多标签页**: 可以同时在多个标签页中观看不同游戏

## 故障排除

### 游戏无法停止
- 检查服务器日志是否有错误信息
- 确认游戏session_id是否正确
- 等待当前轮次完成（最多几分钟）

### 状态更新不及时
- 前端每5秒轮询一次，请耐心等待
- 刷新页面重新加载状态
- 检查网络连接

### API调用失败
- 检查Web服务器是否正在运行
- 确认端口号（默认8081）
- 查看浏览器控制台的错误信息

## 更新日志

- **v1.0**: 添加游戏终止和重启功能
  - 新增停止API端点
  - 新增游戏管理面板
  - 新增直播页面控制按钮
  - 新增状态轮询机制
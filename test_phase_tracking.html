<!DOCTYPE html>
<html>
<head>
    <title>阶段状态跟踪测试</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1f2e;
            color: #e7e9ea;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #475569;
            border-radius: 8px;
            background: #334155;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .improvement { color: #f59e0b; }
        .code {
            background: #0f1419;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .phase-icon {
            font-size: 20px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <h1>🎯 阶段状态跟踪修复</h1>

    <div class="test-case">
        <h3>🔧 问题诊断</h3>
        <div class="error">
            ❌ <strong>原问题：</strong>当前阶段显示不准确<br>
            - 已经在投票了，但状态还是"总结发言"<br>
            - 阶段状态停留在上一个完成的阶段<br>
            - 用户无法实时了解当前游戏进展
        </div>

        <h3>💡 根本原因分析</h3>
        <p>原代码在重新生成消息时，阶段状态会停留在最后处理的阶段，无法准确反映当前正在进行的游戏阶段。</p>
    </div>

    <div class="test-case">
        <h3>✅ 解决方案</h3>
        <div class="success">
            <strong>1. 智能阶段检测</strong> - 添加 <code>findCurrentPhase()</code> 方法<br>
            <strong>2. 实时状态更新</strong> - 根据游戏日志智能判断当前阶段<br>
            <strong>3. 准确状态显示</strong> - 确保显示当前正在进行的阶段
        </div>

        <h4>核心修复代码：</h4>
        <div class="code">
// 在 generateLiveMessages() 方法中添加
const currentPhase = this.findCurrentPhase(logs, state);

// 处理完所有消息后设置当前阶段
if (currentPhase) {
    this.updatePhaseState(currentPhase.type, currentPhase.status,
                        currentPhase.currentAction, currentPhase.totalSteps);
    this.phaseState.startTime = currentPhase.startTime || new Date();
    this.phaseState.progress = currentPhase.progress || 0;
}
        </div>
    </div>

    <div class="test-case">
        <h3>🧠 智能阶段判断逻辑</h3>
        <p>新增的 <code>findCurrentPhase()</code> 方法会按以下逻辑判断当前阶段：</p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">
            <div style="background: #1e293b; padding: 10px; border-radius: 6px;">
                <span class="phase-icon">🔍</span>
                <strong>预言家查验</strong><br>
                <small>检查investigate数据</small>
            </div>
            <div style="background: #1e293b; padding: 10px; border-radius: 6px;">
                <span class="phase-icon">🗡️</span>
                <strong>狼人击杀</strong><br>
                <small>检查eliminate数据</small>
            </div>
            <div style="background: #1e293b; padding: 10px; border-radius: 6px;">
                <span class="phase-icon">🛡️</span>
                <strong>医生保护</strong><br>
                <small>检查protect数据</small>
            </div>
            <div style="background: #1e293b; padding: 10px; border-radius: 6px;">
                <span class="phase-icon">💰</span>
                <strong>竞拍发言</strong><br>
                <small>检查bid数据</small>
            </div>
            <div style="background: #1e293b; padding: 10px; border-radius: 6px;">
                <span class="phase-icon">🗣️</span>
                <strong>辩论发言</strong><br>
                <small>检查debate数据</small>
            </div>
            <div style="background: #1e293b; padding: 10px; border-radius: 6px;">
                <span class="phase-icon">🗳️</span>
                <strong>投票阶段</strong><br>
                <small>检查votes数据</small>
            </div>
            <div style="background: #1e293b; padding: 10px; border-radius: 6px;">
                <span class="phase-icon">📝</span>
                <strong>总结发言</strong><br>
                <small>检查summaries数据</small>
            </div>
        </div>

        <p><strong>判断规则：</strong>如果某个阶段的数据不存在或未完成，则认为是当前正在进行的阶段。</p>
    </div>

    <div class="test-case">
        <h3>🎮 用户体验改善</h3>
        <div class="improvement">
            <p><strong>修复前：</strong></p>
            <ul>
                <li>❌ 阶段状态不准确，显示过时信息</li>
                <li>❌ 用户无法了解当前真实进展</li>
                <li>❌ 时间估计基于错误的阶段</li>
            </ul>

            <p><strong>修复后：</strong></p>
            <ul>
                <li>✅ 实时显示当前正在进行的阶段</li>
                <li>✅ 准确的状态描述和进度显示</li>
                <li>✅ 正确的时间估计和进度条</li>
                <li>✅ 智能识别游戏暂停或等待状态</li>
            </ul>
        </div>
    </div>

    <div class="test-case">
        <h3>📋 测试验证</h3>
        <p>要验证此修复，请：</p>
        <ol>
            <li>启动Web服务器：<code>python3 web_server.py</code></li>
            <li>创建一个新游戏</li>
            <li>观看游戏直播页面</li>
            <li>观察右侧栏的"🎯 当前阶段"面板</li>
            <li>检查阶段状态是否与实际游戏进展一致</li>
        </ol>

        <p><strong>预期效果：</strong>阶段状态应该准确反映当前正在进行的游戏阶段，不会再出现状态滞后的问题。</p>
    </div>

    <button onclick="window.close()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
        关闭测试页面
    </button>
</body>
</html>